{"version":3,"file":"FocusTrap-BpA4_dSM.js","sources":["../../../packages/lake/src/hooks/useInterval.ts","../../../packages/lake/src/hooks/useOutsideClick.ts","../../../packages/lake/src/utils/a11y.ts","../../../packages/lake/src/components/FocusTrap.tsx"],"sourcesContent":["import { useEffect, useRef } from \"react\";\n\nexport const useInterval = (handler: (id: number) => void, timeout: number) => {\n  const handlerRef = useRef(handler);\n\n  useEffect(() => {\n    handlerRef.current = handler;\n  }, [handler]);\n\n  useEffect(() => {\n    const id = window.setInterval(() => handlerRef.current(id), timeout);\n    return () => window.clearInterval(id);\n  }, [timeout]);\n};\n","import { RefObject, useCallback, useEffect, useRef } from \"react\";\nimport { isNotNullish, isNullish } from \"../utils/nullish\";\n\ntype Params = {\n  containerRef: RefObject<unknown>;\n  onClickOutside?: (event: MouseEvent | TouchEvent) => void;\n  // The following prop is necessary for the cases where the user clicks on a focusable element\n  // when leaving a popover, in order to prevent the focus from going back to the pressable that\n  // initiated the layer to pop\n  onFocusOutside?: (event: FocusEvent) => void;\n};\n\nexport const useOutsideClick = ({ containerRef, onClickOutside, onFocusOutside }: Params) => {\n  const hasTouchStartedRef = useRef(false);\n\n  const isTargetInside = useCallback(\n    (event: MouseEvent | TouchEvent | FocusEvent) => {\n      const target = event.target as Element;\n      // NOTE: Let's be careful with the `instanceof` check if we're ever to render a portal to another window\n      return (\n        isNotNullish(containerRef.current) &&\n        containerRef.current instanceof HTMLElement &&\n        containerRef.current.contains(target)\n      );\n    },\n    [containerRef],\n  );\n\n  useEffect(() => {\n    if (isNullish(onClickOutside)) {\n      return;\n    }\n\n    const onTouchStart = (event: MouseEvent | TouchEvent) => {\n      if (!isTargetInside(event)) {\n        hasTouchStartedRef.current = true;\n      }\n    };\n\n    const onTouchEnd = (event: MouseEvent | TouchEvent) => {\n      if (!isTargetInside(event) && hasTouchStartedRef.current) {\n        onClickOutside?.(event);\n      }\n\n      hasTouchStartedRef.current = false;\n    };\n\n    document.addEventListener(\"mousedown\", onTouchStart, true);\n    document.addEventListener(\"mouseup\", onTouchEnd, true);\n    document.addEventListener(\"touchstart\", onTouchStart, true);\n    document.addEventListener(\"touchend\", onTouchEnd, true);\n\n    return () => {\n      document.removeEventListener(\"mousedown\", onTouchStart, true);\n      document.removeEventListener(\"mouseup\", onTouchEnd, true);\n      document.removeEventListener(\"touchstart\", onTouchStart, true);\n      document.removeEventListener(\"touchend\", onTouchEnd, true);\n    };\n  }, [isTargetInside, onClickOutside]);\n\n  useEffect(() => {\n    if (isNullish(onFocusOutside)) {\n      return;\n    }\n\n    const onFocusIn = (event: FocusEvent) => {\n      if (!isTargetInside(event)) {\n        onFocusOutside?.(event);\n      }\n    };\n\n    // We use the `focusin` event so that we can intercept during the capturing phase\n    // see: https://developer.mozilla.org/en-US/docs/Web/API/Element/focusin_event\n    document.addEventListener(\"focusin\", onFocusIn, true);\n\n    return () => {\n      document.removeEventListener(\"focusin\", onFocusIn, true);\n    };\n  }, [isTargetInside, onFocusOutside]);\n};\n","// Pulled from https://github.com/KittyGiraudel/focusable-selectors\nconst FOCUSABLE_SELECTOR = [\n  'a[href]:not([tabindex^=\"-\"])',\n  'area[href]:not([tabindex^=\"-\"])',\n  'input:not([type=\"hidden\"]):not([type=\"radio\"]):not([disabled]):not([tabindex^=\"-\"])',\n  'input[type=\"radio\"]:not([disabled]):not([tabindex^=\"-\"])',\n  'select:not([disabled]):not([tabindex^=\"-\"])',\n  'textarea:not([disabled]):not([tabindex^=\"-\"])',\n  'button:not([disabled]):not([tabindex^=\"-\"])',\n  'iframe:not([tabindex^=\"-\"])',\n  'audio[controls]:not([tabindex^=\"-\"])',\n  'video[controls]:not([tabindex^=\"-\"])',\n  '[contenteditable]:not([tabindex^=\"-\"])',\n  '[tabindex]:not([tabindex^=\"-\"])',\n].join(\", \");\n\nexport const getFocusableElements = (\n  rootNode: Element = document.documentElement,\n  includeRoot = true,\n): HTMLElement[] => {\n  return (\n    includeRoot && rootNode.matches(FOCUSABLE_SELECTOR) ? [rootNode as HTMLElement] : []\n  ).concat(Array.from(rootNode.querySelectorAll(FOCUSABLE_SELECTOR)));\n};\n","import {\n  ReactNode,\n  Ref,\n  useCallback,\n  useEffect,\n  useImperativeHandle,\n  useRef,\n  useState,\n} from \"react\";\nimport { NativeSyntheticEvent, StyleProp, View, ViewStyle } from \"react-native\";\nimport { match } from \"ts-pattern\";\nimport { useInterval } from \"../hooks/useInterval\";\nimport { useOutsideClick } from \"../hooks/useOutsideClick\";\nimport { getFocusableElements } from \"../utils/a11y\";\nimport { first, last } from \"../utils/array\";\nimport { isNotNullish } from \"../utils/nullish\";\n\nexport type FocusTrapRef = {\n  setInitiallyFocusedElement: (element: HTMLElement) => void;\n};\n\ntype Props = {\n  ref?: Ref<FocusTrapRef>;\n  autoFocus: boolean;\n  children: ReactNode;\n  focusLock: boolean;\n  onClickOutside?: (event: TouchEvent | MouseEvent) => void;\n  onEscapeKey?: () => void;\n  returnFocus: boolean;\n  style?: StyleProp<ViewStyle>;\n};\n\nlet escapeListenerCount = 0;\n\nexport const FocusTrap = ({\n  ref,\n  children,\n  focusLock,\n  onClickOutside,\n  onEscapeKey,\n  returnFocus,\n  style,\n  autoFocus,\n}: Props) => {\n  const containerRef = useRef<View>(null);\n  const previouslyFocusedRef = useRef<HTMLElement>(null);\n  const hasFocusedOutside = useRef(false);\n\n  useImperativeHandle(ref, () => ({\n    setInitiallyFocusedElement: element => {\n      previouslyFocusedRef.current = element;\n    },\n  }));\n\n  const [initialEscapeListenerCount] = useState(escapeListenerCount);\n\n  useEffect(() => {\n    ++escapeListenerCount;\n    return () => {\n      --escapeListenerCount;\n    };\n  });\n\n  // The reason we're listening to the capturing phase instead of the bubbling one is that React Native Web\n  // uses a static preventDefault in its TextInput implementation, which we cannot control.\n  // Listening to the bubbling phase catches the event before RNW has the opportunity to block.\n  const onKeyDownCapture = useCallback(\n    ({ nativeEvent }: NativeSyntheticEvent<React.KeyboardEvent>) => {\n      match(nativeEvent.key)\n        .with(\"Escape\", () => {\n          if (escapeListenerCount === initialEscapeListenerCount + 1) {\n            onEscapeKey?.();\n          }\n        })\n        .with(\"Tab\", () => {\n          if (!focusLock) {\n            return;\n          }\n\n          const trapElement = containerRef.current as unknown as HTMLElement;\n\n          if (isNotNullish(trapElement)) {\n            const target = nativeEvent.target;\n            const focusableElements = getFocusableElements(trapElement);\n            const firstFocusableElement = first(focusableElements);\n            const lastFocusableElement = last(focusableElements);\n\n            if (target === firstFocusableElement && nativeEvent.shiftKey) {\n              nativeEvent.preventDefault();\n              lastFocusableElement?.focus();\n            }\n\n            if (target === lastFocusableElement && !nativeEvent.shiftKey) {\n              nativeEvent.preventDefault();\n              firstFocusableElement?.focus();\n            }\n          }\n        })\n        .otherwise(() => {});\n    },\n    [focusLock, onEscapeKey, initialEscapeListenerCount],\n  );\n\n  useEffect(() => {\n    if (returnFocus) {\n      previouslyFocusedRef.current = document.activeElement as HTMLElement;\n\n      return () => {\n        if (!hasFocusedOutside.current) {\n          previouslyFocusedRef.current?.focus();\n        }\n      };\n    }\n  }, [returnFocus]);\n\n  useInterval(id => {\n    if (autoFocus) {\n      const trapElement = containerRef.current as unknown as HTMLElement;\n\n      if (isNotNullish(trapElement)) {\n        if (trapElement.offsetWidth === 0) {\n          return;\n        }\n\n        const focusableElements = getFocusableElements(trapElement);\n        const firstFocusableElement = first(focusableElements);\n\n        firstFocusableElement?.focus();\n        window.clearInterval(id);\n      }\n    }\n  }, 16);\n\n  const onFocusOutside = useCallback(() => {\n    hasFocusedOutside.current = true;\n  }, []);\n\n  useOutsideClick({\n    containerRef,\n    onClickOutside,\n    onFocusOutside,\n  });\n\n  return (\n    <View ref={containerRef} onKeyDownCapture={onKeyDownCapture} style={style}>\n      {children}\n    </View>\n  );\n};\n"],"names":["useInterval","handler","timeout","handlerRef","useRef","useEffect","id","useOutsideClick","containerRef","onClickOutside","onFocusOutside","hasTouchStartedRef","isTargetInside","useCallback","event","target","isNotNullish","isNullish","onTouchStart","onTouchEnd","onFocusIn","FOCUSABLE_SELECTOR","getFocusableElements","rootNode","includeRoot","escapeListenerCount","FocusTrap","ref","children","focusLock","onEscapeKey","returnFocus","style","autoFocus","previouslyFocusedRef","hasFocusedOutside","useImperativeHandle","element","initialEscapeListenerCount","useState","onKeyDownCapture","nativeEvent","match","trapElement","focusableElements","firstFocusableElement","first","lastFocusableElement","last","View"],"mappings":"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"}