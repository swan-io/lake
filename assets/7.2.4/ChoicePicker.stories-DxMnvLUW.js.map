{"version":3,"file":"ChoicePicker.stories-DxMnvLUW.js","sources":["../../../packages/lake/src/utils/viewport.ts","../../../packages/shared-business/src/components/ChoicePicker.tsx"],"sourcesContent":["import { Future } from \"@swan-io/boxed\";\nimport { isNotNullish } from \"./nullish\";\nimport { isSafari } from \"./userAgent\";\n\n// Prevents Safari from zooming automatically on inputs, still allow user to zoom manually\nexport const preventSafariAutoZoomOnInputs = () => {\n  if (isSafari) {\n    const viewport = document.querySelector(\"meta[name=viewport]\");\n    const content = viewport?.getAttribute(\"content\");\n\n    if (isNotNullish(viewport) && isNotNullish(content)) {\n      viewport.setAttribute(\"content\", content + \", maximum-scale=1.0\");\n    }\n  }\n};\n\n// When using `node.scroll()` with smooth behavior, there isn't any event to detect when the scroll animation is finished\n// We need this also with `ScrollView.scrollTo` (which just call the native node.scroll function)\n// More info about why this workaround: https://stackoverflow.com/a/60001032\nexport const detectScrollAnimationEnd = (element: HTMLElement): Future<void> => {\n  let lastScrollTop = element.scrollTop;\n  let lastScrollLeft = element.scrollLeft;\n\n  return Future.make<void>(resolve => {\n    let frame: number | undefined;\n\n    // We need to wait a bit before starting the loop because first requestAnimationFrame is called before the scroll animation starts\n    const timeout = setTimeout(() => {\n      const loop = () => {\n        frame = requestAnimationFrame(() => {\n          if (lastScrollTop !== element.scrollTop || lastScrollLeft !== element.scrollLeft) {\n            lastScrollTop = element.scrollTop;\n            lastScrollLeft = element.scrollLeft;\n            loop();\n          } else {\n            resolve();\n          }\n        });\n      };\n\n      loop();\n    }, 50);\n\n    return () => {\n      clearTimeout(timeout);\n      if (frame != null) {\n        cancelAnimationFrame(frame);\n      }\n    };\n  });\n};\n","import { LakeButton } from \"@swan-io/lake/src/components/LakeButton\";\nimport { LakeRadio } from \"@swan-io/lake/src/components/LakeRadio\";\nimport { Pressable } from \"@swan-io/lake/src/components/Pressable\";\nimport { Space } from \"@swan-io/lake/src/components/Space\";\nimport { Tile } from \"@swan-io/lake/src/components/Tile\";\nimport { commonStyles } from \"@swan-io/lake/src/constants/commonStyles\";\nimport { breakpoints, negativeSpacings, spacings } from \"@swan-io/lake/src/constants/design\";\nimport { useResponsive } from \"@swan-io/lake/src/hooks/useResponsive\";\nimport { clampValue } from \"@swan-io/lake/src/utils/math\";\nimport { detectScrollAnimationEnd } from \"@swan-io/lake/src/utils/viewport\";\nimport { ReactNode, useEffect, useRef, useState } from \"react\";\nimport { ScrollView, StyleSheet, View } from \"react-native\";\nimport { match } from \"ts-pattern\";\nimport { t } from \"../utils/i18n\";\n\nconst styles = StyleSheet.create({\n  root: {\n    alignSelf: \"stretch\",\n    alignItems: \"stretch\",\n    flexGrow: 1,\n    overflow: \"hidden\",\n    marginHorizontal: negativeSpacings[12],\n  },\n  scrollSnap: {\n    scrollSnapType: \"x mandatory\",\n  },\n  container: {\n    alignSelf: \"stretch\",\n    flexDirection: \"row\",\n    flexWrap: \"wrap\",\n    alignItems: \"stretch\",\n    justifyContent: \"center\",\n  },\n  mobileContainer: {\n    flexWrap: \"nowrap\",\n    justifyContent: \"flex-start\",\n    transitionProperty: \"transform\",\n    transitionDuration: \"300ms\",\n    transitionTimingFunction: \"ease-in-out\",\n  },\n  item: {\n    flexGrow: 0,\n    flexBasis: \"33.333%\",\n    maxWidth: 300,\n    padding: spacings[12],\n  },\n  itemAnimation: {\n    transform: \"translateZ(0px)\",\n    animationKeyframes: {\n      from: {\n        opacity: 0,\n        transform: \"translateZ(0px) translateX(50px)\",\n      },\n      to: {\n        opacity: 1,\n        transform: \"translateZ(0px) translateX(0px)\",\n      },\n    },\n    animationDuration: \"200ms\",\n    animationFillMode: \"backwards\",\n    animationTimingFunction: \"ease-in-out\",\n  },\n  itemLarge: {\n    flexBasis: \"50%\",\n    maxWidth: \"none\",\n  },\n  itemSmallViewport: {\n    width: \"100%\",\n    flexBasis: \"auto\",\n    maxWidth: \"none\",\n    scrollSnapAlign: \"center\",\n  },\n  tileContents: {\n    alignItems: \"center\",\n    alignSelf: \"stretch\",\n    flexGrow: 1,\n  },\n  tileRenderedContents: {\n    alignItems: \"center\",\n    alignSelf: \"stretch\",\n    flexGrow: 1,\n  },\n  leftButton: {\n    position: \"absolute\",\n    top: \"50%\",\n    left: negativeSpacings[24],\n    transform: \"translateY(-50%)\",\n    borderTopLeftRadius: 0,\n    borderBottomLeftRadius: 0,\n    borderWidth: 1,\n    borderLeftWidth: 0,\n  },\n  rightButton: {\n    position: \"absolute\",\n    top: \"50%\",\n    right: negativeSpacings[24],\n    transform: \"translateY(-50%)\",\n    borderTopRightRadius: 0,\n    borderBottomRightRadius: 0,\n    borderWidth: 1,\n    borderRightWidth: 0,\n  },\n});\n\ntype Props<T> = {\n  items: T[];\n  large?: boolean;\n  renderItem: (value: T) => ReactNode;\n  value?: T;\n  getId?: (item: T) => unknown;\n  onChange: (value: T) => void;\n  disabled?: boolean;\n};\n\nconst identity = <T,>(x: T) => x;\n\nexport const ChoicePicker = <T,>({\n  items,\n  getId = identity,\n  large = false,\n  renderItem,\n  value,\n  disabled = false,\n  onChange,\n}: Props<T>) => {\n  const containerRef = useRef<ScrollView | null>(null);\n  const { desktop } = useResponsive(breakpoints.medium);\n  const [mobilePosition, setMobilePosition] = useState<\"start\" | \"middle\" | \"end\">(\"start\");\n\n  useEffect(() => {\n    if (desktop) {\n      return;\n    }\n\n    // auto scroll to selected value on mobile\n    const scrollContainer = containerRef.current;\n    const index = items.findIndex(item => value === item);\n    if (index !== -1 && scrollContainer instanceof HTMLDivElement) {\n      const width = scrollContainer.offsetWidth;\n      scrollContainer.scrollTo({ x: index * width, animated: false });\n    }\n\n    // if no value is selected, select first item\n    if (value == null && items[0] != null) {\n      onChange(items[0]);\n    }\n    // disable exhaustive-deps because we only want to run this effect only when screen size go from desktop to mobile\n  }, [desktop]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  const onScroll = () => {\n    // prevent scroll event when we change screen size from mobile to desktop\n    if (desktop) {\n      return;\n    }\n\n    const scrollContainer = containerRef.current;\n    if (scrollContainer instanceof HTMLDivElement) {\n      const scrollLeft = scrollContainer.scrollLeft;\n      const width = scrollContainer.offsetWidth;\n      const index = clampValue(0, items.length - 1)(Math.round(scrollLeft / width));\n      const item = items[index];\n      if (item != null) {\n        onChange(item);\n      }\n\n      match(index)\n        .with(0, () => setMobilePosition(\"start\"))\n        .with(items.length - 1, () => setMobilePosition(\"end\"))\n        .otherwise(() => setMobilePosition(\"middle\"));\n    }\n  };\n\n  const onPressPrevious = () => {\n    const scrollContainer = containerRef.current;\n    if (scrollContainer instanceof HTMLDivElement) {\n      const scrollLeft = scrollContainer.scrollLeft;\n      const width = scrollContainer.offsetWidth;\n      const index = Math.round(scrollLeft / width);\n      const previousIndex = Math.max(0, index - 1);\n\n      // remove scroll snap during scroll animation to avoid weird behavior on older browsers\n      scrollContainer.style.scrollSnapType = \"none\";\n      containerRef.current?.scrollTo({ x: previousIndex * width, animated: true });\n      detectScrollAnimationEnd(scrollContainer).onResolve(() => {\n        // set back scroll snap\n        // @ts-expect-error\n        scrollContainer.style.scrollSnapType = null;\n      });\n    }\n  };\n\n  const onPressNext = () => {\n    const scrollContainer = containerRef.current;\n    if (scrollContainer instanceof HTMLDivElement) {\n      const scrollLeft = scrollContainer.scrollLeft;\n      const width = scrollContainer.offsetWidth;\n      const index = Math.round(scrollLeft / width);\n      const nextIndex = Math.min(items.length - 1, index + 1);\n\n      // remove scroll snap during scroll animation to avoid weird behavior on older browsers\n      scrollContainer.style.scrollSnapType = \"none\";\n      containerRef.current?.scrollTo({ x: nextIndex * width, animated: true });\n      detectScrollAnimationEnd(scrollContainer).onResolve(() => {\n        // set back scroll snap\n        // @ts-expect-error\n        scrollContainer.style.scrollSnapType = null;\n      });\n    }\n  };\n\n  return (\n    <View>\n      <View style={styles.root}>\n        <ScrollView\n          ref={containerRef}\n          horizontal={!desktop}\n          onScroll={onScroll}\n          scrollEventThrottle={200}\n          style={styles.scrollSnap}\n          contentContainerStyle={[\n            styles.container,\n            !desktop && styles.mobileContainer,\n            !desktop && { width: `${items.length * 100}%` },\n          ]}\n        >\n          {items.map((item, index) => (\n            <Pressable\n              key={String(index)}\n              disabled={disabled}\n              style={[\n                styles.item,\n                disabled && commonStyles.disabled,\n                desktop && styles.itemAnimation, // set enter animation only on desktop because it can break scroll snap\n                desktop && { animationDelay: `${200 + 100 * index}ms` },\n                large && styles.itemLarge,\n                !desktop && styles.itemSmallViewport,\n                !desktop && { width: `${100 / items.length}%` },\n              ]}\n              onPress={() => onChange(item)}\n            >\n              {({ hovered }) => (\n                <Tile\n                  hovered={hovered}\n                  selected={value != null && getId(item) === getId(value)}\n                  flexGrow={1}\n                >\n                  <View style={styles.tileContents}>\n                    <View style={styles.tileRenderedContents}>{renderItem(item)}</View>\n\n                    {desktop && (\n                      <>\n                        <Space height={24} />\n                        <LakeRadio value={value != null && getId(item) === getId(value)} />\n                      </>\n                    )}\n                  </View>\n                </Tile>\n              )}\n            </Pressable>\n          ))}\n        </ScrollView>\n      </View>\n\n      {!desktop && (\n        <LakeButton\n          icon=\"chevron-left-filled\"\n          mode=\"secondary\"\n          forceBackground={true}\n          onPress={onPressPrevious}\n          disabled={mobilePosition === \"start\" || disabled}\n          style={styles.leftButton}\n          ariaLabel={t(\"common.previous\")}\n        />\n      )}\n\n      {!desktop && (\n        <LakeButton\n          icon=\"chevron-right-filled\"\n          mode=\"secondary\"\n          forceBackground={true}\n          onPress={onPressNext}\n          disabled={mobilePosition === \"end\" || disabled}\n          style={styles.rightButton}\n          ariaLabel={t(\"common.next\")}\n        />\n      )}\n    </View>\n  );\n};\n"],"names":["detectScrollAnimationEnd","element","lastScrollTop","lastScrollLeft","Future","resolve","frame","timeout","loop","styles","StyleSheet","negativeSpacings","spacings","identity","x","ChoicePicker","items","getId","large","renderItem","value","disabled","onChange","containerRef","useRef","desktop","useResponsive","breakpoints","mobilePosition","setMobilePosition","useState","useEffect","scrollContainer","index","item","width","onScroll","scrollLeft","clampValue","match","onPressPrevious","previousIndex","_a","onPressNext","nextIndex","View","jsx","ScrollView","Pressable","commonStyles","hovered","Tile","jsxs","Fragment","Space","LakeRadio","LakeButton","t"],"mappings":"+yBAmBa,MAAAA,EAA4BC,GAAuC,CAC9E,IAAIC,EAAgBD,EAAQ,UACxBE,EAAiBF,EAAQ,WAEtB,OAAAG,EAAO,KAAsBC,GAAA,CAC9B,IAAAC,EAGE,MAAAC,EAAU,WAAW,IAAM,CAC/B,MAAMC,EAAO,IAAM,CACjBF,EAAQ,sBAAsB,IAAM,CAC9BJ,IAAkBD,EAAQ,WAAaE,IAAmBF,EAAQ,YACpEC,EAAgBD,EAAQ,UACxBE,EAAiBF,EAAQ,WACpBO,KAEGH,GACV,CACD,CAAA,EAGEG,KACJ,EAAE,EAEL,MAAO,IAAM,CACX,aAAaD,CAAO,EAChBD,GAAS,MACX,qBAAqBA,CAAK,CAC5B,CACF,CACD,CACH,ECnCAG,EAAAC,EAAA,OAAA,CACA,KAAA,CACA,UAAA,UACA,WAAA,UACA,SAAA,EACA,SAAA,SACA,iBAAAC,EAAA,EAAA,CACA,EACA,WAAA,CACA,eAAA,aACA,EACA,UAAA,CACA,UAAA,UACA,cAAA,MACA,SAAA,OACA,WAAA,UACA,eAAA,QACA,EACA,gBAAA,CACA,SAAA,SACA,eAAA,aACA,mBAAA,YACA,mBAAA,QACA,yBAAA,aACA,EACA,KAAA,CACA,SAAA,EACA,UAAA,UACA,SAAA,IACA,QAAAC,EAAA,EAAA,CACA,EACA,cAAA,CACA,UAAA,kBACA,mBAAA,CACA,KAAA,CACA,QAAA,EACA,UAAA,kCACA,EACA,GAAA,CACA,QAAA,EACA,UAAA,iCACA,CACA,EACA,kBAAA,QACA,kBAAA,YACA,wBAAA,aACA,EACA,UAAA,CACA,UAAA,MACA,SAAA,MACA,EACA,kBAAA,CACA,MAAA,OACA,UAAA,OACA,SAAA,OACA,gBAAA,QACA,EACA,aAAA,CACA,WAAA,SACA,UAAA,UACA,SAAA,CACA,EACA,qBAAA,CACA,WAAA,SACA,UAAA,UACA,SAAA,CACA,EACA,WAAA,CACA,SAAA,WACA,IAAA,MACA,KAAAD,EAAA,EAAA,EACA,UAAA,mBACA,oBAAA,EACA,uBAAA,EACA,YAAA,EACA,gBAAA,CACA,EACA,YAAA,CACA,SAAA,WACA,IAAA,MACA,MAAAA,EAAA,EAAA,EACA,UAAA,mBACA,qBAAA,EACA,wBAAA,EACA,YAAA,EACA,iBAAA,CACA,CACA,CAAA,EAYAE,EAAAC,GAAAA,EAEAC,EAAA,CAAA,CACA,MAAAC,EACA,MAAAC,EAAAJ,EACA,MAAAK,EAAA,GACA,WAAAC,EACA,MAAAC,EACA,SAAAC,EAAA,GACA,SAAAC,CACA,IAAA,CACA,MAAAC,EAAAC,SAAA,IAAA,EACA,CAAA,QAAAC,CAAA,EAAAC,EAAAC,EAAA,MAAA,EACA,CAAAC,EAAAC,CAAA,EAAAC,WAAA,OAAA,EAEAC,EAAAA,UAAA,IAAA,CACA,GAAAN,EACA,OAIA,MAAAO,EAAAT,EAAA,QACAU,EAAAjB,EAAA,UAAAkB,GAAAd,IAAAc,CAAA,EACA,GAAAD,IAAA,IAAAD,aAAA,eAAA,CACA,MAAAG,EAAAH,EAAA,YACAA,EAAA,SAAA,CAAA,EAAAC,EAAAE,EAAA,SAAA,GAAA,CACA,CAGAf,GAAA,MAAAJ,EAAA,CAAA,GAAA,MACAM,EAAAN,EAAA,CAAA,CAAA,CACA,EAEA,CAAAS,CAAA,CAAA,EAEA,MAAAW,EAAA,IAAA,CAEA,GAAAX,EACA,OAGA,MAAAO,EAAAT,EAAA,QACA,GAAAS,aAAA,eAAA,CACA,MAAAK,EAAAL,EAAA,WACAG,EAAAH,EAAA,YACAC,EAAAK,EAAA,EAAAtB,EAAA,OAAA,CAAA,EAAA,KAAA,MAAAqB,EAAAF,CAAA,CAAA,EACAD,EAAAlB,EAAAiB,CAAA,EACAC,GAAA,MACAZ,EAAAY,CAAA,EAGAK,EAAAN,CAAA,EACA,KAAA,EAAA,IAAAJ,EAAA,OAAA,CAAA,EACA,KAAAb,EAAA,OAAA,EAAA,IAAAa,EAAA,KAAA,CAAA,EACA,UAAA,IAAAA,EAAA,QAAA,CAAA,CACA,CAAA,EAGAW,EAAA,IAAA,OACA,MAAAR,EAAAT,EAAA,QACA,GAAAS,aAAA,eAAA,CACA,MAAAK,EAAAL,EAAA,WACAG,EAAAH,EAAA,YACAC,EAAA,KAAA,MAAAI,EAAAF,CAAA,EACAM,EAAA,KAAA,IAAA,EAAAR,EAAA,CAAA,EAGAD,EAAA,MAAA,eAAA,QACAU,EAAAnB,EAAA,UAAA,MAAAmB,EAAA,SAAA,CAAA,EAAAD,EAAAN,EAAA,SAAA,KACAnC,EAAAgC,CAAA,EAAA,UAAA,IAAA,CAGAA,EAAA,MAAA,eAAA,IAAA,CACA,CACA,CAAA,EAGAW,EAAA,IAAA,OACA,MAAAX,EAAAT,EAAA,QACA,GAAAS,aAAA,eAAA,CACA,MAAAK,EAAAL,EAAA,WACAG,EAAAH,EAAA,YACAC,EAAA,KAAA,MAAAI,EAAAF,CAAA,EACAS,EAAA,KAAA,IAAA5B,EAAA,OAAA,EAAAiB,EAAA,CAAA,EAGAD,EAAA,MAAA,eAAA,QACAU,EAAAnB,EAAA,UAAA,MAAAmB,EAAA,SAAA,CAAA,EAAAE,EAAAT,EAAA,SAAA,KACAnC,EAAAgC,CAAA,EAAA,UAAA,IAAA,CAGAA,EAAA,MAAA,eAAA,IAAA,CACA,CACA,CAAA,EAGA,cACAa,EACA,CAAA,SAAA,CAAAC,EAAA,IAAAD,EAAA,CAAA,MAAApC,EAAA,KACA,SAAAqC,EAAA,IAAAC,EAAA,CACA,IAAAxB,EACA,WAAA,CAAAE,EACA,SAAAW,EACA,oBAAA,IACA,MAAA3B,EAAA,WACA,sBAAA,CACAA,EAAA,UACA,CAAAgB,GAAAhB,EAAA,gBACA,CAAAgB,GAAA,CAAA,MAAA,GAAAT,EAAA,OAAA,GAAA,GAAA,CACA,EAEA,SAAAA,EAAA,IAAA,CAAAkB,EAAAD,IACAa,EAAA,IAAAE,EAAA,CAEA,SAAA3B,EACA,MAAA,CACAZ,EAAA,KACAY,GAAA4B,EAAA,SACAxB,GAAAhB,EAAA,cACAgB,GAAA,CAAA,eAAA,GAAA,IAAA,IAAAQ,CAAA,IAAA,EACAf,GAAAT,EAAA,UACA,CAAAgB,GAAAhB,EAAA,kBACA,CAAAgB,GAAA,CAAA,MAAA,GAAA,IAAAT,EAAA,MAAA,GAAA,CACA,EACA,QAAA,IAAAM,EAAAY,CAAA,EAEA,SAAA,CAAA,CAAA,QAAAgB,CAAA,IACAJ,EAAA,IAAAK,EAAA,CACA,QAAAD,EACA,SAAA9B,GAAA,MAAAH,EAAAiB,CAAA,IAAAjB,EAAAG,CAAA,EACA,SAAA,EAEA,SAAAgC,EAAA,KAAAP,EAAA,CAAA,MAAApC,EAAA,aACA,SAAA,CAAAqC,MAAAD,GAAA,MAAApC,EAAA,qBAAA,SAAAU,EAAAe,CAAA,EAAA,EAEAT,GAEA2B,EAAA,KAAAC,WAAA,CAAA,SAAA,CAAAP,EAAAA,IAAAQ,EAAA,CAAA,OAAA,EAAA,CAAA,EACAR,EAAAA,IAAAS,EAAA,CAAA,MAAAnC,GAAA,MAAAH,EAAAiB,CAAA,IAAAjB,EAAAG,CAAA,CAAA,CAAA,CAAA,EACA,CAAA,EAEA,CAAA,CACA,CAAA,EA7BA,OAAAa,CAAA,CAAA,CAgCA,CAAA,CAAA,EAEA,EAEA,CAAAR,GACAqB,EAAA,IAAAU,EAAA,CACA,KAAA,sBACA,KAAA,YACA,gBAAA,GACA,QAAAhB,EACA,SAAAZ,IAAA,SAAAP,EACA,MAAAZ,EAAA,WACA,UAAAgD,EAAA,iBAAA,CAAA,CACA,EAGA,CAAAhC,GACAqB,EAAA,IAAAU,EAAA,CACA,KAAA,uBACA,KAAA,YACA,gBAAA,GACA,QAAAb,EACA,SAAAf,IAAA,OAAAP,EACA,MAAAZ,EAAA,YACA,UAAAgD,EAAA,aAAA,CAAA,CACA,CAEA,CAAA,CAAA,CAEA;;;;;;;;;;;;;;;;;;;;;;;;;"}