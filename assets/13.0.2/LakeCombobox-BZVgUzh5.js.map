{"version":3,"file":"LakeCombobox-BZVgUzh5.js","sources":["../../../packages/lake/src/components/LakeCombobox.tsx"],"sourcesContent":["import { AsyncData, Result } from \"@swan-io/boxed\";\nimport { ReactNode, Ref, useCallback, useId, useImperativeHandle, useRef, useState } from \"react\";\nimport {\n  NativeSyntheticEvent,\n  Pressable,\n  StyleSheet,\n  Text,\n  TextInput,\n  TextInputKeyPressEventData,\n  View,\n} from \"react-native\";\nimport { backgroundColor, colors, spacings } from \"../constants/design\";\nimport { useMergeRefs } from \"../hooks/useMergeRefs\";\nimport { getFocusableElements } from \"../utils/a11y\";\nimport { isNotEmpty } from \"../utils/nullish\";\nimport { Box } from \"./Box\";\nimport { FlatList } from \"./FlatList\";\nimport { Icon, IconName } from \"./Icon\";\nimport { LakeText } from \"./LakeText\";\nimport { LakeTextInput, LakeTextInputProps } from \"./LakeTextInput\";\nimport { LoadingView } from \"./LoadingView\";\nimport { Popover } from \"./Popover\";\nimport { Separator } from \"./Separator\";\nimport { Space } from \"./Space\";\n\nconst DEFAULT_ELEMENT_HEIGHT = 64;\nconst DEFAULT_NB_SUGGESTION_DISPLAYED = 3.5;\n\nconst styles = StyleSheet.create({\n  list: {\n    marginVertical: spacings[8],\n  },\n  flatList: {\n    scrollBehavior: \"smooth\",\n  },\n  item: {\n    flexShrink: 1,\n    flexGrow: 1,\n    justifyContent: \"center\",\n    paddingHorizontal: spacings[24],\n    paddingVertical: 0,\n    transitionProperty: \"background-color\",\n    transitionDuration: \"200ms\",\n    outlineStyle: \"none\",\n    justifyContents: \"center\",\n  },\n  hoveredItem: {\n    backgroundColor: colors.gray[0],\n  },\n  focusedItem: {\n    backgroundColor: colors.gray[0],\n  },\n  pressedItem: {\n    backgroundColor: colors.gray[100],\n  },\n  itemText: {\n    userSelect: \"none\",\n  },\n  loader: {\n    padding: spacings[24],\n  },\n  listContainer: {\n    flexGrow: 1,\n    flexShrink: 1,\n  },\n  loaderAdditional: {\n    ...StyleSheet.absoluteFillObject,\n    alignItems: \"center\",\n    justifyContent: \"center\",\n  },\n  loaderAdditionalUnderlay: {\n    ...StyleSheet.absoluteFillObject,\n    backgroundColor: backgroundColor.accented,\n    opacity: 0.8,\n  },\n  emptyList: {\n    height: 136,\n  },\n  emptyListText: {\n    color: colors.gray.primary,\n  },\n  input: {\n    width: 1,\n    flexGrow: 1,\n  },\n});\n\nexport type LakeComboboxRef = {\n  close: () => void;\n  open: () => void;\n};\n\nexport type LakeComboboxProps<I> = {\n  ref?: Ref<LakeComboboxRef>;\n  inputRef?: Ref<unknown>;\n  value: string;\n  items: AsyncData<Result<I[], unknown>>;\n  itemHeight?: number;\n  nbItemsDisplayed?: number;\n  ListFooterComponent?: ReactNode;\n  onChange?: LakeTextInputProps[\"onChange\"];\n  onValueChange: (value: string) => void;\n  onSelectItem: (value: I) => void | Promise<unknown>;\n  renderItem: (item: I) => ReactNode | null;\n  keyExtractor: (item: I) => string;\n  icon?: IconName;\n  placeholder?: string;\n  disabled?: boolean;\n  emptyResultText: string;\n  error?: string;\n  hideErrors?: boolean;\n  id?: string;\n  readOnly?: boolean;\n};\n\nexport const LakeCombobox = <I,>({\n  ref,\n  inputRef,\n  value,\n  items,\n  itemHeight = DEFAULT_ELEMENT_HEIGHT,\n  nbItemsDisplayed = DEFAULT_NB_SUGGESTION_DISPLAYED,\n  ListFooterComponent,\n  onChange,\n  onValueChange,\n  onSelectItem,\n  renderItem,\n  keyExtractor,\n  icon,\n  placeholder,\n  disabled = false,\n  emptyResultText,\n  readOnly,\n  id,\n  error,\n  hideErrors,\n}: LakeComboboxProps<I>) => {\n  const innerInputRef = useRef<TextInput>(null);\n  const inputTextRef = useMergeRefs(innerInputRef, inputRef);\n\n  const listContainerRef = useRef<View>(null);\n  const blurTimeoutId = useRef<number>(undefined);\n  const [isFetchingAdditionalInfo, setIsFetchingAdditionalInfo] = useState(false);\n\n  // The Combobox has two distinct closed states: \"closed\" and \"dismissed\"\n  // When it's \"closed\", it will open on input focus or text change\n  // When it's \"dismissed\", it will NOT open on input focus, but will on text change\n  const [state, setState] = useState<\"opened\" | \"closed\" | \"dismissed\">(\"closed\");\n  const open = useCallback(() => setState(\"opened\"), []);\n  const close = useCallback(() => setState(\"closed\"), []);\n  const dismiss = useCallback(() => setState(\"dismissed\"), []);\n\n  useImperativeHandle(ref, () => {\n    return {\n      open,\n      close,\n    };\n  });\n\n  const suggestionsId = useId();\n\n  const handleKeyPress = useCallback((event: NativeSyntheticEvent<TextInputKeyPressEventData>) => {\n    if (event.nativeEvent.key === \"ArrowDown\") {\n      const listElement = listContainerRef.current;\n\n      if (listElement != null) {\n        const element = listElement as unknown as Element;\n        const focusableElements = getFocusableElements(element, false);\n        focusableElements[0]?.focus();\n        event.preventDefault();\n      }\n    }\n  }, []);\n\n  const handleListItemKeyPress = useCallback(\n    (event: NativeSyntheticEvent<TextInputKeyPressEventData>) => {\n      if (event.nativeEvent.key === \"ArrowDown\" || event.nativeEvent.key === \"ArrowUp\") {\n        const listElement = listContainerRef.current;\n\n        if (listElement != null) {\n          const element = listElement as unknown as Element;\n          const target = event.currentTarget as unknown as HTMLElement;\n          const focusableElements = getFocusableElements(element, false);\n          const index = focusableElements.indexOf(target);\n          const direction = event.nativeEvent.key === \"ArrowDown\" ? 1 : -1;\n\n          if (index === -1) {\n            return;\n          }\n\n          const nextIndex = index + direction;\n          event.preventDefault();\n\n          if (nextIndex === -1) {\n            innerInputRef.current?.focus();\n          } else {\n            focusableElements[nextIndex === focusableElements.length ? 0 : nextIndex]?.focus();\n          }\n        }\n      }\n    },\n    [],\n  );\n\n  const handleChangeText = useCallback(\n    (value: string) => {\n      onValueChange(value);\n      setState(isNotEmpty(value) ? \"opened\" : \"closed\");\n    },\n    [onValueChange],\n  );\n\n  const handleFocus = useCallback(() => {\n    if (isNotEmpty(value)) {\n      window.clearTimeout(blurTimeoutId.current);\n\n      blurTimeoutId.current = window.setTimeout(() => {\n        setState(prevState => (prevState === \"closed\" ? \"opened\" : prevState));\n      }, 100);\n    }\n  }, [value]);\n\n  const handleBlur = useCallback(() => {\n    window.clearTimeout(blurTimeoutId.current);\n\n    blurTimeoutId.current = window.setTimeout(() => {\n      setState(\"dismissed\");\n    }, 100);\n  }, []);\n\n  return (\n    <View>\n      <LakeTextInput\n        containerRef={inputTextRef as Ref<View>}\n        style={styles.input}\n        ariaExpanded={state === \"opened\"}\n        ariaControls={state === \"opened\" ? suggestionsId : \"\"}\n        enterKeyHint=\"search\"\n        icon={icon}\n        role=\"combobox\"\n        placeholder={placeholder}\n        value={value}\n        disabled={disabled}\n        error={error}\n        hideErrors={hideErrors}\n        onChangeText={handleChangeText}\n        onChange={onChange}\n        onFocus={handleFocus}\n        onBlur={handleBlur}\n        onKeyPress={handleKeyPress}\n        id={id}\n        readOnly={readOnly}\n      />\n\n      <Popover\n        id={suggestionsId}\n        role=\"listbox\"\n        matchReferenceWidth={true}\n        onEscapeKey={dismiss}\n        referenceRef={innerInputRef}\n        autoFocus={false}\n        returnFocus={true}\n        visible={state === \"opened\" && !items.isNotAsked()}\n        underlay={false}\n        forcedMode=\"Dropdown\"\n      >\n        <View style={[styles.list, { maxHeight: itemHeight * nbItemsDisplayed }]}>\n          {items.match({\n            NotAsked: () => null,\n            Loading: () => <LoadingView style={styles.loader} />,\n            Done: items =>\n              items.match({\n                Error: _ => (\n                  <Icon name=\"error-circle-regular\" size={22} color={colors.negative[500]} />\n                ),\n                Ok: items => (\n                  <View ref={listContainerRef} style={styles.listContainer}>\n                    {items.length === 0 ? (\n                      <Box justifyContent=\"center\" alignItems=\"center\" style={styles.emptyList}>\n                        <Icon\n                          name=\"clipboard-search-regular\"\n                          size={24}\n                          color={colors.gray.primary}\n                        />\n\n                        <Space height={8} />\n                        <Text style={styles.emptyListText}>{emptyResultText}</Text>\n                      </Box>\n                    ) : (\n                      <FlatList\n                        keyExtractor={keyExtractor}\n                        role=\"list\"\n                        data={items}\n                        style={styles.flatList}\n                        ItemSeparatorComponent={<Separator />}\n                        renderItem={({ item }) => {\n                          const rendered = renderItem(item);\n\n                          return (\n                            <Pressable\n                              onFocus={handleFocus}\n                              onBlur={handleBlur}\n                              role=\"listitem\"\n                              onKeyDown={handleListItemKeyPress}\n                              style={({ hovered, pressed, focused }) => [\n                                styles.item,\n                                hovered && styles.hoveredItem,\n                                focused && styles.focusedItem,\n                                pressed && styles.pressedItem,\n                                { height: itemHeight },\n                              ]}\n                              onPress={() => {\n                                window.clearTimeout(blurTimeoutId.current);\n                                setIsFetchingAdditionalInfo(true);\n\n                                void Promise.resolve(onSelectItem(item)).finally(() => {\n                                  setIsFetchingAdditionalInfo(false);\n                                  dismiss();\n                                });\n                              }}\n                            >\n                              {typeof rendered === \"string\" || typeof rendered === \"number\" ? (\n                                <LakeText numberOfLines={1} style={styles.itemText}>\n                                  {rendered}\n                                </LakeText>\n                              ) : (\n                                rendered\n                              )}\n                            </Pressable>\n                          );\n                        }}\n                      />\n                    )}\n\n                    {ListFooterComponent}\n\n                    {isFetchingAdditionalInfo ? (\n                      <View style={styles.loaderAdditional}>\n                        <View style={styles.loaderAdditionalUnderlay} />\n                        <LoadingView />\n                      </View>\n                    ) : null}\n                  </View>\n                ),\n              }),\n          })}\n        </View>\n      </Popover>\n    </View>\n  );\n};\n"],"names":["DEFAULT_ELEMENT_HEIGHT","DEFAULT_NB_SUGGESTION_DISPLAYED","styles","StyleSheet","spacings","colors","backgroundColor","LakeCombobox","ref","inputRef","value","items","itemHeight","nbItemsDisplayed","ListFooterComponent","onChange","onValueChange","onSelectItem","renderItem","keyExtractor","icon","placeholder","disabled","emptyResultText","readOnly","id","error","hideErrors","innerInputRef","useRef","inputTextRef","useMergeRefs","listContainerRef","blurTimeoutId","isFetchingAdditionalInfo","setIsFetchingAdditionalInfo","useState","state","setState","open","useCallback","close","dismiss","useImperativeHandle","suggestionsId","useId","handleKeyPress","event","listElement","getFocusableElements","handleListItemKeyPress","element","target","focusableElements","index","direction","nextIndex","handleChangeText","isNotEmpty","handleFocus","prevState","handleBlur","View","jsx","LakeTextInput","Popover","LoadingView","_","Icon","jsxs","Box","Space","Text","FlatList","Separator","item","rendered","Pressable","hovered","pressed","focused","LakeText"],"mappings":"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"}