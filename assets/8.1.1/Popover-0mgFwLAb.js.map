{"version":3,"file":"Popover-0mgFwLAb.js","sources":["../../../packages/lake/src/components/Popover.tsx"],"sourcesContent":["import { memo, ReactNode, RefObject, useCallback, useEffect, useRef, useState } from \"react\";\nimport {\n  AnimationStyles,\n  GestureResponderEvent,\n  Pressable,\n  ScrollView,\n  StyleSheet,\n  Text,\n  View,\n} from \"react-native\";\nimport { match, P } from \"ts-pattern\";\nimport {\n  Animation,\n  animations,\n  backgroundColor,\n  radii,\n  shadows,\n  spacings,\n} from \"../constants/design\";\nimport { useContextualLayer } from \"../hooks/useContextualLayer\";\nimport { useResponsive } from \"../hooks/useResponsive\";\nimport { noop } from \"../utils/function\";\nimport { BottomPanel } from \"./BottomPanel\";\nimport { FocusTrap } from \"./FocusTrap\";\nimport { Portal } from \"./Portal\";\nimport { TransitionView } from \"./TransitionView\";\n\ntype Props = {\n  children: ReactNode | ((state: { mode: \"dropdown\" | \"panel\" }) => ReactNode);\n  id?: string;\n  label?: string;\n  role?: \"listbox\" | \"combobox\" | \"dialog\";\n  describedBy?: string;\n  matchReferenceWidth?: boolean;\n  matchReferenceMinWidth?: boolean;\n  onDismiss?: () => void;\n  onEscapeKey?: () => void;\n  referenceRef: RefObject<View | Text>;\n  returnFocus?: boolean;\n  autoFocus?: boolean;\n  visible: boolean;\n  underlay?: boolean;\n  safetyMargin?: number;\n  forcedMode?: \"Dropdown\" | \"BottomPanel\";\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    ...StyleSheet.absoluteFillObject,\n    pointerEvents: \"none\",\n  },\n  defaultCursor: {\n    cursor: \"default\",\n  },\n  underlay: {\n    pointerEvents: \"auto\",\n    cursor: \"default\",\n    position: \"fixed\",\n    left: 0,\n    top: 0,\n    bottom: 0,\n    right: 0,\n  },\n  popoverContainer: {\n    position: \"absolute\",\n    display: \"flex\",\n  },\n  popover: {\n    pointerEvents: \"auto\",\n    display: \"flex\",\n    flexDirection: \"column\",\n    backgroundColor: backgroundColor.accented,\n    borderRadius: radii[8],\n    marginVertical: spacings[8],\n    overflow: \"hidden\",\n    boxShadow: shadows.modal,\n    flexGrow: 1,\n    alignSelf: \"stretch\",\n  },\n  popoverContents: {\n    alignItems: \"stretch\",\n  },\n});\n\nconst animation: Animation = {\n  ...animations.fadeAndSlideInFromBottom,\n  leave: [\n    animations.fadeAndSlideInFromBottom.leave,\n    { animationDuration: \"100ms\" },\n  ] as unknown as AnimationStyles,\n};\n\nexport const VIEWPORT_WIDTH_THRESHOLD = 600;\n\nexport const Popover = memo<Props>(\n  ({\n    children,\n    id,\n    label,\n    role = \"dialog\",\n    describedBy,\n    matchReferenceWidth = false,\n    matchReferenceMinWidth = false,\n    onDismiss = noop,\n    onEscapeKey = onDismiss,\n    referenceRef,\n    returnFocus = true,\n    autoFocus = true,\n    visible,\n    underlay = true,\n    forcedMode,\n  }) => {\n    const [rootElement, setRootElement] = useState<Element | null>(null);\n    const underlayRef = useRef<View | null>(null);\n    const { desktop } = useResponsive(VIEWPORT_WIDTH_THRESHOLD);\n\n    const { position } = useContextualLayer({\n      referenceRef,\n      visible,\n      matchReferenceWidth,\n      matchReferenceMinWidth,\n    });\n\n    useEffect(() => {\n      const element = underlayRef.current as unknown as HTMLElement | null;\n      if (!visible && element != null) {\n        element.style.pointerEvents = \"none\";\n      }\n    }, [visible]);\n\n    useEffect(() => {\n      const element = document.createElement(\"div\");\n      document.body.append(element);\n      setRootElement(element);\n      return () => {\n        setRootElement(null);\n        element.remove();\n      };\n    }, []);\n\n    const onPressUnderlay = useCallback(\n      (event: GestureResponderEvent) => {\n        event.preventDefault();\n        onDismiss();\n      },\n      [onDismiss],\n    );\n\n    const onClickOutside = useCallback(\n      ({ target }: MouseEvent | TouchEvent) => {\n        const ref = referenceRef.current;\n        if (\n          !(ref instanceof Element) ||\n          !(target instanceof Element) ||\n          (ref !== target && !ref.contains(target))\n        ) {\n          onDismiss();\n        }\n      },\n      [referenceRef, onDismiss],\n    );\n\n    const onPress = useCallback((event: GestureResponderEvent) => {\n      event.preventDefault();\n    }, []);\n\n    if (rootElement == null) {\n      return null;\n    }\n\n    const mode = match(forcedMode)\n      .with(P.nullish, () => (desktop ? \"Dropdown\" : \"BottomPanel\"))\n      .with(\"BottomPanel\", () => \"BottomPanel\" as const)\n      .with(\"Dropdown\", () => \"Dropdown\" as const)\n      .exhaustive();\n\n    if (mode === \"BottomPanel\") {\n      return (\n        <BottomPanel visible={visible} onPressClose={onDismiss} returnFocus={false}>\n          {typeof children == \"function\" ? children({ mode: \"panel\" }) : children}\n        </BottomPanel>\n      );\n    }\n\n    return (\n      <Portal container={rootElement}>\n        {visible && underlay ? (\n          <Pressable\n            ref={underlayRef}\n            style={styles.underlay}\n            onPress={onPressUnderlay}\n            aria-label=\"Close\"\n          />\n        ) : null}\n\n        <TransitionView style={styles.container} {...animation}>\n          {position.isSome() ? (\n            <View style={position.get().rootStyle}>\n              <View\n                style={[\n                  styles.popoverContainer,\n                  position.get().style,\n                  {\n                    alignItems: match(position.get().horizontalPosition)\n                      .with(\"left\", () => \"flex-start\" as const)\n                      .with(\"center\", () => \"center\" as const)\n                      .with(\"right\", () => \"flex-end\" as const)\n                      .exhaustive(),\n                  },\n                ]}\n              >\n                <ScrollView\n                  style={styles.popover}\n                  contentContainerStyle={styles.popoverContents}\n                  id={id}\n                  role={role}\n                  aria-describedby={describedBy}\n                  aria-label={label}\n                >\n                  <FocusTrap\n                    focusLock={true}\n                    returnFocus={returnFocus}\n                    autoFocus={autoFocus}\n                    onEscapeKey={onEscapeKey}\n                    onClickOutside={underlay ? undefined : onClickOutside}\n                  >\n                    <Pressable tabIndex={-1} onPress={onPress} style={styles.defaultCursor}>\n                      {typeof children == \"function\" ? children({ mode: \"dropdown\" }) : children}\n                    </Pressable>\n                  </FocusTrap>\n                </ScrollView>\n              </View>\n            </View>\n          ) : null}\n        </TransitionView>\n      </Portal>\n    );\n  },\n);\n"],"names":["styles","StyleSheet","backgroundColor","radii","spacings","shadows","animation","animations","VIEWPORT_WIDTH_THRESHOLD","Popover","memo","children","id","label","role","describedBy","matchReferenceWidth","matchReferenceMinWidth","onDismiss","noop","onEscapeKey","referenceRef","returnFocus","autoFocus","visible","underlay","forcedMode","rootElement","setRootElement","useState","underlayRef","useRef","desktop","useResponsive","position","useContextualLayer","useEffect","element","onPressUnderlay","useCallback","event","onClickOutside","target","ref","onPress","match","P","BottomPanel","jsxs","Portal","jsx","Pressable","TransitionView","View","ScrollView","FocusTrap"],"mappings":"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"}